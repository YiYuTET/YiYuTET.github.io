<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>10. Kafka 关键原理加强 | 依羽淡蓝</title><meta name="keywords" content="Kafka"><meta name="author" content="YiYuTET,2576556095@qq.com"><meta name="copyright" content="YiYuTET"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="10. Kafka 关键原理加强"><meta name="application-name" content="10. Kafka 关键原理加强"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="10. Kafka 关键原理加强"><meta property="og:url" content="http://example.com/post/216d6a00.html"><meta property="og:site_name" content="依羽淡蓝"><meta property="og:description" content="10. Kafka 关键原理加强10.1 日志分段切分条件日志分段文件切分包含以下4个条件，满足其一即可： (1) 当前日志分段文件的大小超过了broker端参数log.segment.bytes配置的值。log.segment.bytes参数的默认值为1073741824，即1GB(2) 当前日志"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://example.com/image/kafka.png"><meta property="article:author" content="YiYuTET"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/image/kafka.png"><meta name="description" content="10. Kafka 关键原理加强10.1 日志分段切分条件日志分段文件切分包含以下4个条件，满足其一即可： (1) 当前日志分段文件的大小超过了broker端参数log.segment.bytes配置的值。log.segment.bytes参数的默认值为1073741824，即1GB(2) 当前日志"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/post/216d6a00"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={linkPageTop:void 0,peoplecanvas:{enable:!0,img:"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},postHeadAiDescription:void 0,diytitle:{enable:!0,leaveTitle:"w(ﾟДﾟ)w 不要走！再看看嘛！",backTitle:"♪(^∇^*)欢迎肥来！"},LA51:{enable:!0,ck:"3HcBp2tkLPn3VSLn",LingQueMonitorID:"3HcC4I1TJLqPpAjl"},greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:6},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:7,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 宝贝",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://yiyu9901-twikoo.hf.space",commentBarrageConfig:void 0,root:"/",preloader:void 0,friends_vue_info:{apiurl:"https://friends.anheyu.com/"},navMusic:!0,mainTone:{mode:"both",api:"https://img2color-go.vercel.app/api?img=",cover_change:!0},authorStatus:{skills:["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},algolia:{appId:"OCOPQS4EHM",apiKey:"39t2ndtRZKxHPHaprbe6kPaws4vs1nWA94",indexName:"yiyuyyds",hits:{per_page:6},languages:{input_placeholder:"输入关键词后按下回车查找",hits_empty:"找不到您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，用时 ${time} 毫秒"}},localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!1,limitCount:50,languages:{author:"作者: YiYuTET",link:"链接: ",source:"来源: 依羽淡蓝",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-center"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,shortcutKey:{enable:!0,delay:100,shiftDelay:200},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"依羽淡蓝",title:"10. Kafka 关键原理加强",postAI:"",pageFillDescription:"10. Kafka 关键原理加强, 10.1 日志分段切分条件, 10.2 controller控制器, 10.3 分区的负载分布, 10.4 分区Leader的选举机制, 10.5 分区数与吞吐量, 10.6 生产者原理解析, 10.7 重要的生产者参数, 10.7.1 acks, 10.7.2 max.request.size, 10.7.3 retries 和 retry.backoff.ms, 10.7.4 compression.type, 10.7.5 batch.size, 10.7.6 linger.ms, 10.7.7 enable.idempotence, 10.7.8 partitioner.class, 10.8 消费者组再均衡分区分配策略, 10.8.1 Range Strategy, 10.8.2 Round-Robin Strategy, 10.8.3 Sticky Strategy, 10.8.3 CooperativeSticky Strategy, 10.9 消费者组再均衡流程, 10.9.1 GroupCoordinator介绍, 10.9.2 再均衡流程, 10.9.3 再均衡监听器, 10.10 Kafka系统的CAP保证, 10.10.1 分布式系统的CAP理论, 10.10.2 分区副本机制, 10.10.3 ISR同步副本列表, 10.10.4 分区副本的数据一致性解决方案, 10.10.5 HW方案的天生缺陷, 10.10.6 HW会产生数据丢失和副本最终不一致问题, 10.10.7 Leader-Epoch机制的引入, 10.10.8 LEOx2FHWx2FLSO等相关术语速查关键原理加强日志分段切分条件日志分段文件切分包含以下个条件满足其一即可当前日志分段文件的大小超过了端参数配置的值参数的默认值为即当前日志分段中消息的最小时间戳与当前系统的时间戳的差值大于或参数配置的值如果同时配置了和参数那么的优先级高默认情况下只配置了参数其值为即天偏移量索引文件或时间戳索引文件的大小达到端参数配置的值的默认值为即追加的消息的偏移量与当前日志分段的起始偏移量之间的差值大于即要追加的消息的偏移量不能转变为相对偏移量控制器简单来说就是集群的状态管理者在集群中会有一个或者多个其中有一个会被选举为控制器它负责维护整个集群中所有分区和副本的状态及分区的选举当某个分区的副本出现故障时由控制器负责为该分区选举新的副本当检测到某个分区的集合发生变化时由控制器负责通知所有更新其元数据信息当使用脚本为某个增加分区数量时同样还是由控制器负责分区的重新分配中的控制器选举的工作依赖于成功竞选为控制器的会在中创建这个临时节点此临时节点的内容参考如下其中在目前版本中固定为表示成为控制器的的编号表示竞选成为控制器时的时间戳在任意时刻集群中有且仅有一个控制器每个启动的时候会去尝试读取上的节点的的值如果读取到的值不为则表示已经有其它节点成功竞选为控制器所有当前就会放弃竞选如果不存在这个节点或者这个节点中的数据异常那么就会尝试去创建这个节点当前去创建节点的时候也有可能其它同时去尝试创建这个节点只有创建成功的那个才会成为控制器而创建失败的则表示竞选失败每个都会在内存中保存当前控制器的值这个值可以标识为竞选机制简单说先来先上具备控制器身份的需要比其它普通的多一些职责具体细节如下监听相关变化对中的节点注册用来处理分区重分配的动作对中的节点注册用来处理集合变更的动作对中的节点添加用来处理优先副本选举监听增减变化对中的节点添加用来处理增减的变化对中的节点添加用来处理删除的动作监听相关的变化对中的节点添加用来处理增减的变化更新集群的元数据信息从中读取获取当前所有与以及有关的信息并进行相应的管理对各所对应的中的节点添加用来监听中的分区分配变化并将最新信息同步给其它所有启动并管理分区状态机和副本状态机如果参数设置为则还会开启一个名为的定时任务来维护分区的副本的均衡分区的负载分布客户端请求创建一个时每一个分期副本在上的分配是由集群来决定其分布策略源码如下副本因子不能大于的个数的第个副本副本放置位置是随机从选择的其它分区的第个副本放置位置相对与分区依次往后移也就是说如果我们有个个分区假设分区放在上那么将会放在上将会放在上在依此类推各分区剩余的副本相对于分区前一个副本偏移随机数分区的选举机制分区副本的选举由控制器负责具体实施当创建分区创建主题或增加分区都有创建分区的动作或下线此时分区需要选举一个新的上线来对外提供服务的时候都需要执行的选举动作选举策略按照集合中副本的顺序查找第一个存活的副本并且这个副本在集合中一个分区的集合在分配的时候就被指定并且只要不发生重分配的情况集合内部副本的顺序是保持不变的而分区的集合中副本的顺序可能会改变分区数与吞吐量本身提供用于生产者性能测试的和用于消费者性能测试的主要参数如下用来指定生产者发送消息的目标主题用来指定发送消息的总条数用来设置每条消息的字节数参数用来指定生产者的配置可同时指定多组配置各组配置之间以空格分隔与参数对应的还有一个参数它用来指定生产者的配置文件用来进行限流控制当设定的值小于时不限流当设定的值大于时当发送的吞吐量大于该值时就会被阻塞一段时间生产者原理解析一个生产者客户端由两个线程协调运行这两个线程分别为主线程和线程在主线程中由创建消息然后通过可能的拦截器序列化器和分区器的作用之后缓存到消息累加器也称为消息收集器中线程负责从获取消息并将其发送到中主要用来缓存消息以便线程可以批量发送进而减少网络传输的资源消耗以提升性能缓存的大小可以通过生产者客户端参数配置默认值为即如果生产者发送消息的速度超过发送到服务器的速度则会导致生产者空间不足这个时候方法调用要么被阻塞要么抛出异常这个取决于参数的配置此参数的默认值为即秒主线程中发送过来的消息都会被追加到的某个双端队列中内部为每个分区都维护了一个双端队列即消息写入缓存时追加到双端队列的尾部读取消息时从双端队列的头部读取注意是指一个消息批次与此同时会将较小的凑成一个较大也可以减少网络请求的次数以提升整体的吞吐量大小和参数也有着密切的关系当一条消息流入时会先寻找与消息分区所对应的双端队列如果没有则新建再从这个双端队列的尾部获取一个如果没有则新建查看中是否还可以写入这个如果可以则写入如果不可以则需要创建一个新的在新建时评估这条消息的大小是否超过参数大小如果不超过那么就以参数的大小来创建如果生产者客户端需要向很多分区发送消息则可以将参数适当调大以增加整体的吞吐量从获取缓存的消息之后会进一步将分区的形式转变成的形式其中表示集群节点对于网络连接来说生产者客户端是与具体节点建立的连接也就是向具体的节点发送消息而并不关心消息属于哪一个分区而对于的应用逻辑而言我们只关注向哪个分区中发送哪些消息所以在这里需要做一个应用逻辑层面到网络层面的转换在转换成的形式之后会进一步封装成的形式这样就可以将请求发往各个了这里的是各种协议请求请求在从线程发往之前还会保存到中保存对象的具体形式为它的主要作用是缓存了已经发出去但还没有收到服务端响应的请求是一个类型表示节点的编号与此同时还提供了许多管理类的方法并且通过配置参数还可以限制每个连接也就是客户端与之间的连接最多缓存的请求数这个配置参数为默认值为即每个连接最多只能缓存个未响应的请求超过该数值之后就不能再向这个连接发送更多的请求了除非有缓存的请求收到了响应通过比较的与这个参数的大小来判断对应的中是否己经堆积了很多未响应的消息如果真是如此那么说明这个节点负载较大或网络连接有问题再继续发送请求会增大请求超时的可能重要的生产者参数是控制生产者在发送出消息后如何得到确认生产者根据得到的确认信息来判断消息发送是否成功含义往集群发送数据不需要等到集群的确认信息不确保消息发送成功安全性最低但是效率最高往集群发送数据只要成功写入消息就可以发送下一条只确保接收成功或往集群发送数据需要所有的都完成从的同步才会发送下一条确保发送成功和所有的副本都成功接收安全性最高但是效率最低生产者将设置为是否就一定不会丢数据呢否如果在某个时刻列表只剩自己了那么就算收到这条数据还是只有一个节点可以配合另外一个参数缓解此情况最小同步副本数端参数默认这个参数用来限制生产者客户端能发送的消息的最大值默认值为即一般情况下这个默认值就可以满足大多数的应用场景了这个参数还涉及一些其它参数的联动比如端级别参数的参数默认如果配置错误可能会引起一些不必要的异常比如将端的参数配置为而参数配置为那么当发送一条大小为的消息时生产者客户端就会报出异常和参数用来配置生产者重试的次数默认值为即在发生异常的时候不进行任何重试动作消息在从生产者发出到成功写入服务器之前可能发生一些临时性的异常比如网络抖动副本的选举等这种异常往往是可以自行恢复的生产者可以通过配置大于的值以此通过内部重试来恢复而不是一味地将异常抛给生产者的应用程序如果重试达到设定的次数那么生产者就会放弃重试并返回异常重试还和另一个参数有关这个参数的默认值为它用来设定两次重试之间的时间间隔避免无效的频繁重试可以保证同一个分区中的消息是有序的如果生产者按照一定的顺序发送消息那么这些消息也会顺序地写入分区进而消费者也可以按照同样的顺序消费它们对于某些应用来说顺序性非常重要比如的传输如果出现错误就会造成非常严重的后果如果将参数配置为非零值并且参数配置为大于的值那可能会出现错序的现象如果批次消息写入失败而批次消息写入成功那么生产者会重试发送批次的消息此时如果批次的消息写入成功那么这两个批次的消息就出现了错序一般而言在需要保证消息顺序的场合建议把参数配置为而不是把配置为不过这样也会影响整体的吞吐这个参数用来指定消息的压缩方式默认值为即默认情况下消息不会被压缩该参数还可以配置为和对消息进行压缩可以极大地减少网络传输降低网络从而提高整体的性能消息压缩是一种以时间换空间的优化方式如果对时延有一定的要求则不推荐对消息进行压缩每个要存放大小的数据后才可以发送出去比如说默认值是那么里面凑够的数据才会发送理论上来说提升的大小可以允许更多的数据缓冲在里面那么一次发送出去的数据量就更多了这样吞吐量可能会有所提升但是也不能过大要是数据老是缓冲在里迟迟不发送出去那么发送消息的延迟就会很高一般可以尝试把这个参数调节大些利用生产环境发消息负载测试一下这个参数用来指定生产者发送之前等待更多消息加入时间默认值为生产者客户端会在填满或等待时间超过值时发送出去增大这个参数的值会增加消息的延迟但是同时能提升一定的吞吐量是否开启幂等性功能详见后续原理加强幂等性就是一个操作重复做也不会影响最终的结果非幂等操作幂等操作在中同一条消息生产者如果多次重试发送在服务器中的结果如果还是只有一条这就是具备幂等性否则就不具备幂等性用来指定分区器默认默认分区器的分区规则如果数据中有则按的值分区总数得到目标分区如果数据只有则在各个分区间轮询自定义需要实现接口消费者组再均衡分区分配策略消费者组的意义何在为了提高数据处理的并行度当以下事件发生时将会进行一次分区分配同一个内新增或减少了消费者订阅的主题新增分区订阅的主题增加将分区的消费权从一个消费者移到另一个消费者称为再均衡如何也涉及到分区分配策略内部存在两种的分区分配策略默认和消费者组的分区分配策略消费者组的负载均衡策略消费者组的再均衡策略先将消费者按照字典排序然后按逐个处理针对一个将其总数消费者数得到商和余数则每个至少分到个分区且前个每人多分一个分区举例说明假设有有个分区由个来消费得到商余则每个消费者至少分个分区前两个消费者各多个分区个分区个分区个分区接下来就按照区间进行分配举例说明假设有个分区有个分区由个来消费先分配得到商余则有个分区有个分区得到结果再分配得到商余则有个分区有个分区得到结果最终分配结果将所有主题分区组成列表并对列表按照其排序然后以轮询的方式分配给各消费者以上述例来举例先对的排序假如排序结果如下然后按轮询方式分配我们可以通过参数选择或参数默认的值是这个参数属于消费者参数对应的类叫做策略的特点要去达成最大化的均衡尽可能保留各消费者原来分配的分区再均衡的过程中还是会让各消费者先取消自身的分区然后再重新分配只不过是分配过程中会尽量让原来属于谁的分区依然分配给谁对应的类叫做策略的特点逻辑与策略一致支持再均衡机制再均衡的过程中不会让所有消费者取消掉所有分区然后再进行重分配消费者组再均衡流程消费组在消费数据的时候有两个角色进行组内的各事务的协调角色组协调器位于服务端就是某个角色组长位于消费端就是消费组中的某个消费者介绍每个消费组在服务端对应一个进行管理是服务端中用于管理消费组的组件消费者客户端中由组件负责与进行交互和最重要的职责就是负责执行消费者操作包括前面提及的分区分配工作也是在期间完成的会触发的事件可能是如下任意一种有新的消费者加入消费组有消费者宕机下线消费者并不一定需要真正下线例如遇到长时间的网络延迟导致消费者长时间未向发送心跳等情况时会认为消费者己下线有消费者主动退出消费组发送请求比如客户端调用了方法取消对某些主题的订阅消费组所对应的节点发生了变更消费组内所订阅的任一主题或者主题的分区数量发生变化再均衡流程阶段定位在我们组记偏移量的分区的所在上查找的方式先根据消费组的值计算它应该所在中的分区编号为的分区总数这个可以通过端参数来配置默认值是找到对应的分区号后再寻找此分区副本所在节点则此节点即为自己的阶段加入组此阶段的重要操作之选举消费组的消费组的选举策略就是随机此阶段的重要操作之选择分区分配策略最终选举的分配策略基本上可以看作被各个消费者支持的最多的策略具体的选举过程如下收集各个消费者支持的所有分配策略组成候选集每个消费者从候选集找出第一个自身支持的策略为这个策略投上一票计算候选集中各个策略的选票数选票数最多的策略即为当前消费组的分配策略其实此逻辑并不需要来执行而是由来执行阶段组信息同步此阶段主要是由消费组将分区分配方案通过来转发给组中各消费者阶段心跳联系进入这个阶段之后消费组中的所有消费者就会处于正常工作状态各消费者在消费数据的同时保持与的心跳通信消费者的心跳间隔时间由参数指定默认值为即这个参数必须比参数设定的值要小一般情况下的配置值不能超过配置值的这个参数可以调整得更低以控制正常重新平衡的预期时间如果一个消费者发生崩溃并停止读取消息那么会等待一小段时间确认这个消费者死亡之后才会触发再均衡在这一小段时间内死掉的消费者并不会读取分区里的消息这个一小段时间由参数控制该参数的配置值必须在端参数再均衡监听器一个消费组中一旦有消费者的增减发生会触发消费者组的再均衡如果想控制消费者在发生再均衡时执行一些特定的工作可以通过订阅主题时注册再均衡监听器来实现场景举例在发生再均衡时处理消费位移如果消费者消费掉的一批消息还没来得及提交而它所负贵的分区在中转移给了消费者则有可能发生数据的重复消费处理此情形下可以通过再均衡监听器做一定程度的补救代码示例被取消旧分区后被调用分配到新的分区后被调用系统的保证分布式系统的理论理论作为分布式系统的基础理论它描述的是一个分布式系统在以下三个特性中一致性可用性分区容错性最多满足其中的两个特性也就是下图所描述的分布式系统要么满足要么要么无法同时满足分区容错性指的是分布式系统中的某个节点或者网络分区出现了故障的时候整个系统仍然能对外提供满足一致性和可用性的服务也就是说部分故障不影响整体使用事实上我们在设计分布式系统是都会考虑到硬件网络等各种原因造成的故障所以即使部分节点或者网络出现故障我们要求整个系统还是要继续使用的不继续使用相当于只有一个分区那么也就没有后续的一致性和可用性了可用性一直可以正常的做读写操作简单而言就是客户端一直可以正常访问并得到系统的正常响应用户角度来看就是不会出现系统操作失败或者访问超时等问题一致性在分布式系统完成某些操作后任何读操作都应该获取到该写操作写入的那个最新的值相当于要求分布式系统中的各节点时时刻刻保持数据的一致性作为一个商业级消息中间件数据可靠性和可用性是优先考虑的重点兼顾尽可能保证数据一致性分区副本机制从版本开始引入了分区副本引入了数据冗余也就是说每个分区可以人为的配置几个副本创建主题的时候指定也可以在级别进行配置在众多的分区副本里面有一个副本是其余的副本是所有的读写操作都是经过进行的同时会定期地去上复制数据当挂了的时候其中一个会重新成为新的通过分区副本引入了数据冗余同时也提供了的数据可靠性的分区多副本架构是可靠性保证的核心把消息写入多个副本可以使在发生崩溃时仍能保证消息的持久性同步副本列表概念同步副本每个分区的会维护一个列表列表里面就是副本的编号只有跟得上的副本才能加入到里面这个是通过默认值参数配置的只有里的成员才有被选为的可能分区副本的数据一致性解决方案让分区多副本同步的基本手段是副本定期向请求数据同步既然是定期同步则和之间必然存在各种数据不一致的情景动态过程中的副本数据不一致是很难解决的先尝试着解决上述消费者所见不一致及分区数据最终不一致的问题解决方案的核心思想在动态不一致的过程中维护一条步进式的临时一致线既所谓的高水位线副本中最小底层逻辑就是的是各副本间一致的且安全的如上图所示的是所有副本都已经备份好的数据解决消费者所见不一致消费者只允许看到以下的解决分区副本数据最终不一致数据按截断方案的天生缺陷如前所述看似解决了分区数据最终不一致的问题以及消费者所见不一致的问题但其实这里面存在一个巨大的隐患导致分区数据最终不一致的问题依然存在设置后依然有可能丢失数据的问题产生如上结果的根源是高水位线的更新与数据同步的进度存在迟滞和副本处于初始化值副本发送请求由于副本没有数据因此不会进行同步操作生产者发送了消息到分区副本写入该条消息后更新发送请求携带当前最新的处理请求时更新对比值最小为所以副本响应消息数据及给写入消息后更新值同时对比值取最小的作为新的值此时这也意味着是不会超过值的发送第二轮请求携带当前最新的处理请求时更新对比值最小为所以此时没有新的消息数据所以直接返回给对比当前最新的值与值取最小的作为新的值此时从以上步骤可看出中保存的值的更新也即的更新总是需要额外一轮请求才能完成这意味着在切换过程中会存在数据丢失以及数据不一致的问题会产生数据丢失和副本最终不一致问题数据丢失的问题即使设置依然会发生注意中的值是在下一轮请求中完成更新的如上图所示状态起始为为最新消息已同步但的比的大在此时崩溃即没能通过下一轮请求来更新值重启时会自动将值调整到之前的值即会进行日志截断重启后会从向发送请求收到响应后拿到值并更新本地值这时会做日志截断因此的消息被永久地删除了副本间数据最终不一致的问题即使设置依然会发生如上图所示状态起始为为最新消息已同步但的比的大在此时崩溃即没能通过下一轮请求来更新值先重启会自动将值调整到之前的值即会进行日志截断并在此刻接收了新的消息随之上升为然后重启上线会从向发送请求收到响应后拿到值并更新本地值发现不需要截断从而己经产生了副本间数据最终不一致只要新一届在老重启上线前接收了新的数据就可能发生上图中的场景根源也在于的更新落后于数据同步进度机制的引入为了解决更新时机是异步延迟的而又是决定日志是否备份成功的标志从而造成数据丢失和数据不一致的现象引入了机制在每个副本日志目录下都创建一个文件用于保存的信息它的格式为指的是版本它是一个单调递增的一个正整数值每次变更版本都会是每一代写入的第一条消息的位移值比如以上第个版本是从位移开始写入消息意味着第一个版本写入了的消息具体的工作机制当副本成为时这时如果此时生产者有新消息发送过来会首先更新以及并添加到文件中当副本变成时发送请求给副本该请求包括了中最新的版本返回给的响应中包含了一个如果纪元相同则否则取中最小的的值举个例子假设此时有则拿到之后会对比当前值是否大于如果当前大于则从截断日志开始发送请求给保持消息同步解决数据丢失如上图所示重启之后发送请求给由于还没追加消息此时因此返给拿到之后发现等于当前值故不用进行日志截断就在这时宕机了成为在启动回来后会重复的动作同样不需要进行日志截断数据没有丢失解决数据最终不一致问题如上图所示和同时宕机后先重启回来成为分区这时候生产者发送了一条消息过来更新到此时启动回来后发送给判断不等于最新的于是找到大于最小的即拿到后判断小于当前值于是从位置进行日志截断接着开始发送请求给开始同步消息避免了消息不一致离散的问题等相关术语速查就是该副本中消息的最大偏移量的值各副本中的最小值这个值规定了消费者仅能消费之前的数据一个副本的中最小的消息偏移量最后一个稳定的对未完成的事务而言的值等于事务中第一条消息的位置对已完成的事务而言它的值同相同",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-03-12 10:11:39",postMainColor:"#241E03"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{if(0===a)return;const o={value:t,expiry:Date.now()+864e5*a};localStorage.setItem(e,JSON.stringify(o))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const a=JSON.parse(t);if(!(Date.now()>a.expiry))return a.value;localStorage.removeItem(e)}},e.getScript=(e,t={})=>new Promise((a,o)=>{const c=document.createElement("script");c.src=e,c.async=!0,c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},Object.keys(t).forEach(e=>{c.setAttribute(e,t[e])}),document.head.appendChild(c)}),e.getCSS=(e,t=!1)=>new Promise((a,o)=>{const c=document.createElement("link");c.rel="stylesheet",c.href=e,t&&(c.id=t),c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},document.head.appendChild(c)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};const t=saveToLocal.get("theme"),a=window.matchMedia("(prefers-color-scheme: dark)").matches,o=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!a&&!o&&!c;if(void 0===t){if(o)activateLightMode();else if(a)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())})}else"light"===t?activateLightMode():activateDarkMode();const d=saveToLocal.get("aside-status");void 0!==d&&("hide"===d?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css"><meta name="generator" content="Hexo 7.1.1"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://yiyuyyds.cn/" title="依羽淡蓝的博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="依羽淡蓝的博客"><span class="back-menu-item-text">依羽淡蓝的博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://upyun.com/" title="又拍云"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="又拍云"><span class="back-menu-item-text">又拍云</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://music.163.com/" title="网易云音乐"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="网易云音乐"><span class="back-menu-item-text">网易云音乐</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"><span class="back-menu-item-text">安知鱼图床</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://7bu.top/" title="去不图床"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="去不图床"><span class="back-menu-item-text">去不图床</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.imgurl.org/" title="ImgURL"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="ImgURL"><span class="back-menu-item-text">ImgURL</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">依羽淡蓝</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=5085901384&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i><span> 我的装备</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" alt="微信" src="/null"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="/null"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">音乐</div><span class="author-content-item-title">灵魂的碰撞💥</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">42</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Kafka/" itemprop="url">Kafka</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Kafka/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Kafka</span></a></span></div></div><h1 class="post-title" itemprop="name headline">10. Kafka 关键原理加强</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-03-12T02:10:26.000Z" title="发表于 2024-03-12 10:10:26">2024-03-12</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-03-12T02:11:39.207Z" title="更新于 2024-03-12 10:11:39">2024-03-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span data-flag-title="10. Kafka 关键原理加强"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为南昌"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>南昌</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/post/216d6a00.html#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/image/kafka.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/post/216d6a00.html"><header><a class="post-meta-categories" href="/categories/Kafka/" itemprop="url">Kafka</a><a href="/tags/Kafka/" tabindex="-1" itemprop="url">Kafka</a><h1 id="CrawlerTitle" itemprop="name headline">10. Kafka 关键原理加强</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">YiYuTET</span><time itemprop="dateCreated datePublished" datetime="2024-03-12T02:10:26.000Z" title="发表于 2024-03-12 10:10:26">2024-03-12</time><time itemprop="dateCreated datePublished" datetime="2024-03-12T02:11:39.207Z" title="更新于 2024-03-12 10:11:39">2024-03-12</time></header><h1 id="10-Kafka-关键原理加强"><a href="#10-Kafka-关键原理加强" class="headerlink" title="10. Kafka 关键原理加强"></a>10. Kafka 关键原理加强</h1><h2 id="10-1-日志分段切分条件"><a href="#10-1-日志分段切分条件" class="headerlink" title="10.1 日志分段切分条件"></a>10.1 日志分段切分条件</h2><p><font size="3"><b>日志分段文件切分包含以下4个条件，满足其一即可：</b></font></p><p>(1) <font size="3"><b>当前日志分段文件的大小超过了broker端参数<u>log.segment.bytes</u>配置的值。<br>log.segment.bytes参数的默认值为1073741824，即1GB</b></font><br>(2) <font size="3"><b>当前日志分段中消息的最小时间戳与当前系统的时间戳的差值大于<u>log.roll.ms</u>或++log.roll.hours++参数配置的值。如果同时配置了log.roll.ms和log.roll.hours参数，那么log.roll.ms的优先级高。默认情况下，只配置了log.roll.hours参数，其值为168，即7天。</b></font><br>(3) <font size="3"><b>偏移量索引文件或时间戳索引文件的大小达到broker端参数<u>log.index.size.max.bytes</u>配置的值。log.index.size.max.bytes的默认值为10485760，即10MB</b></font><br>(4) <font size="3"><b>追加的消息的偏移量与当前日志分段的起始偏移量之间的差值大于Integer.MAX_VALUE，即要追加的消息的偏移量不能转变为相对偏移量(offset - baseOffset &gt; Integer.MAX_VALUE)。<br></b></font></p><h2 id="10-2-controller控制器"><a href="#10-2-controller控制器" class="headerlink" title="10.2 controller控制器"></a>10.2 controller控制器</h2><p><font size="3"><b><u>Controller简单来说，就是kafka集群的状态管理者</u> <br>在kafka集群中会有一个或者多个broker，<u>其中有一个broker会被选举为控制器（Kafka Controller），</u><br><u>它负责维护整个集群中所有分区和副本的状态及分区leader的选举</u>。当某个分区的leader副本出现故障时，由控制器负责为该分区选举新的leader副本。当检测到某个分区的ISR集合发生变化时，由控制器负责通知所有broker更新其元数据信息。当使用kafka-topic.sh脚本为某个topic增加分区数量时，同样还是由控制器负责分区的重新分配。</b></font></p><p><font size="3"><b>Kafka中的控制器选举的工作依赖于Zookeeper，成功竞选为控制器的broker会在Zookeeper中创建&#x2F;controller这个临时(EPHEMERAL)节点，此临时节点的内容参考如下: <br>{“version”:1,”broker”:0,”timestamp”:”1529210278988”}<br>其中version在目前版本中固定为1，brokerid表示成为控制器的broker的id编号，timestamp表示竞选成为控制器时的时间戳。 <br><u>在任意时刻，集群中有且仅有一个控制器。</u>每个broker启动的时候会去尝试读取zookeeper上的&#x2F;controller节点的brokerid的值，如果读取到brokerid的值不为-1，则表示已经有其它broker节点成功竞选为控制器，所有当前就会放弃竞选；如果zookeeper不存在&#x2F;controller这个节点，或者这个节点中的数据异常，那么就会尝试去创建&#x2F;controller这个节点，当前broker去创建节点的时候，也有可能其它broker同时去尝试创建这个节点，只有创建成功的那个broker才会成为控制器，而创建失败的broker则表示竞选失败。每个broker都会在内存中保存当前控制器的brokerid值，这个值可以标识为activeControllerId。</b></font></p><p><font size="3"><b><u>controller竞选机制，简单说，先来先上</u><br></b></font></p><p>具备控制器身份的broker需要比其它普通的broker多一些职责，具体细节如下：</p><ul><li><p>监听partition相关变化<br>对Zookeeper中的&#x2F;admin&#x2F;reassign_partitions节点注册PartitionReassignmentListener，用来处理分区重分配的动作。<br>对Zookeeper中的&#x2F;isr_change_notification节点注册IsrChangeNotificationListener，用来处理ISR集合变更的动作。<br>对Zookeeper中的&#x2F;admin&#x2F;preferred-replica-election节点添加PreferredReplicaElectionListener，用来处理优先副本选举。</p></li><li><p>监听topic增减变化<br>对Zookeeper中的&#x2F;brokers&#x2F;topics节点添加TopicChangeListener，用来处理topic增减的变化。<br>对Zookeeper中的&#x2F;admin&#x2F;delete_topics节点添加TopicDeletionListener，用来处理删除topic的动作。</p></li><li><p>监听broker相关的变化<br>对Zookeeper中的&#x2F;brokers&#x2F;ids&#x2F;节点添加BrokerChangeListener，用来处理broker增减的变化。</p></li><li><p>更新集群的元数据信息<br>从Zookeeper中读取获取当前所有与topic、partition以及broker有关的信息并进行相应的管理，对各topic所对应的Zookeeper中的&#x2F;brokers&#x2F;topics&#x2F;[topic]节点添加PartitionModificationsListener，用来监听topic中的分区分配变化，并将最新信息同步给其它所有broker。</p></li><li><p>启动并管理分区状态机和副本状态机</p></li><li><p>如果参数auto.leader.rebalance.enable设置为true，则还会开启一个名为“auto-leader-rebalance-task”的定时任务来维护分区的leader副本的均衡</p></li></ul><h2 id="10-3-分区的负载分布"><a href="#10-3-分区的负载分布" class="headerlink" title="10.3 分区的负载分布"></a>10.3 分区的负载分布</h2><p><font size="3"><b>客户端请求创建一个topic时，每一个分期副本在broker上的分配，是由集群controller来决定；<br>其分布策略源码如下：<br></b></font></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">assignReplicasToBrokersRackUnaware</span></span>(nPartitions: <span class="type">Int</span>,</span><br><span class="line">                                                 replicationFactor: <span class="type">Int</span>,</span><br><span class="line">                                                 brokerList: <span class="type">Seq</span>[<span class="type">Int</span>],</span><br><span class="line">                                                 fixedStartIndex: <span class="type">Int</span>,</span><br><span class="line">                                                 startPartitionId: <span class="type">Int</span>): <span class="type">Map</span>[<span class="type">Int</span>, <span class="type">Seq</span>[<span class="type">Int</span>]] = &#123;</span><br><span class="line">    <span class="keyword">val</span> ret = mutable.<span class="type">Map</span>[<span class="type">Int</span>, <span class="type">Seq</span>[<span class="type">Int</span>]]()</span><br><span class="line">    <span class="keyword">val</span> brokerArray = brokerList.toArray</span><br><span class="line">    <span class="keyword">val</span> startIndex = <span class="keyword">if</span> (fixedStartIndex &gt;= <span class="number">0</span>) fixedStartIndex <span class="keyword">else</span> rand.nextInt(brokerArray.length)</span><br><span class="line">    <span class="keyword">var</span> currentPartitionId = math.max(<span class="number">0</span>, startPartitionId)</span><br><span class="line">    <span class="keyword">var</span> nextReplicaShift = <span class="keyword">if</span> (fixedStartIndex &gt;= <span class="number">0</span>) fixedStartIndex <span class="keyword">else</span> rand.nextInt(brokerArray.length)</span><br><span class="line">    <span class="keyword">for</span> (_ &lt;- <span class="number">0</span> until nPartitions) &#123;</span><br><span class="line">      <span class="keyword">if</span> (currentPartitionId &gt; <span class="number">0</span> &amp;&amp; (currentPartitionId % brokerArray.length == <span class="number">0</span>))</span><br><span class="line">        nextReplicaShift += <span class="number">1</span></span><br><span class="line">      <span class="keyword">val</span> firstReplicaIndex = (currentPartitionId + startIndex) % brokerArray.length</span><br><span class="line">      <span class="keyword">val</span> replicaBuffer = mutable.<span class="type">ArrayBuffer</span>(brokerArray(firstReplicaIndex))</span><br><span class="line">      <span class="keyword">for</span> (j &lt;- <span class="number">0</span> until replicationFactor - <span class="number">1</span>)</span><br><span class="line">        replicaBuffer += brokerArray(replicaIndex(firstReplicaIndex, nextReplicaShift, j, brokerArray.length))</span><br><span class="line">      ret.put(currentPartitionId, replicaBuffer)</span><br><span class="line">      currentPartitionId += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    ret</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">replicaIndex</span></span>(firstReplicaIndex : <span class="type">Int</span>, secondReplicaShift : <span class="type">Int</span>, replicaIndex : <span class="type">Int</span>, nBrokers : <span class="type">Int</span>) : <span class="type">Int</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> shift = <span class="number">1</span> + (secondReplicaShift + replicaIndex) % (nBrokers - <span class="number">1</span>)</span><br><span class="line">    (firstReplicaIndex + shift) % nBrokers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>副本因子不能大于Broker的个数；</li><li>partition_0的第1个副本(leader副本)放置位置是随机从brokerList选择的；</li><li>其它分区的第1个副本放置位置相对与partition_0分区依次往后移（也就是说如果我们有5个Broker，5个分区，假设partition0分区放在broker4上，那么partition1将会放在broker5上；partition2将会放在broker1上，partition3在broker2，依此类推）</li><li>各分区剩余的副本相对于分区前一个副本偏移随机数nextReplicaShift</li></ul><h2 id="10-4-分区Leader的选举机制"><a href="#10-4-分区Leader的选举机制" class="headerlink" title="10.4 分区Leader的选举机制"></a>10.4 分区Leader的选举机制</h2><p><u>分区leader副本的选举由控制器controller负责具体实施。</u><br>当创建分区(创建主题或增加分区都有创建分区的动作)或Leader下线(此时分区需要选举一个新的leader上线来对外提供服务)的时候都需要执行leader的选举动作。</p><p><u>选举策略：按照AR集合中副本的顺序查找第一个存活的副本，并且这个副本在ISR集合中；</u><br>一个分区的AR集合在partition分配的时候就被指定，并且只要不发生重分配的情况，集合内部副本的顺序是保持不变的，而分区的ISR集合中副本的顺序可能会改变；</p><h2 id="10-5-分区数与吞吐量"><a href="#10-5-分区数与吞吐量" class="headerlink" title="10.5 分区数与吞吐量"></a>10.5 分区数与吞吐量</h2><p>Kafka本身提供用于生产者性能测试的 kafka-producer-perf-test.sh 和用于消费者性能测试的 kafka-consumer-perf-test.sh，主要参数如下：</p><ul><li>topic用来指定生产者发送消息的目标主题；</li><li>num-records用来指定发送消息的总条数</li><li>record-size用来设置每条消息的字节数；</li><li>producer-props参数用来指定生产者的配置，可同时指定多组配置，各组配置之间以空格分隔与producer-props参数对应的还有一个producer-config参数，它用来指定生产者的配置文件</li><li>throughput用来进行限流控制，当设定的值小于0时不限流，当设定的值大于0时，当发送的吞吐量大于该值时就会被阻塞一段时间。</li></ul><h2 id="10-6-生产者原理解析"><a href="#10-6-生产者原理解析" class="headerlink" title="10.6 生产者原理解析"></a>10.6 生产者原理解析</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114154.jpeg" alt="Kafka图9"></p><p>一个生产者客户端由两个线程协调运行，这两个线程分别为主线程和Sender线程。<br>在主线程中由kafkaProducer创建消息，然后通过可能的拦截器、序列化器和分区器的作用之后缓存<br>到消息累加器(RecordAccumulator，也称为消息收集器)中。</p><p>Sender线程负责从RecordAccumulator获取消息并将其发送到Kafka中；</p><p>RecordAccumulator主要用来缓存消息以便Sender线程可以批量发送，进而减少网络传输的资源消耗以提升性能。RecordAccumulator缓存的大小可以通过生产者客户端参数++buffer.memory++配置，默认值为33554432B，即32M。如果生产者发送消息的速度超过发送到服务器的速度，则会导致生产者空间不足，这个时候KafkaProducer.send()方法调用要么被阻塞，要么抛出异常，这个取决于参数++max.block.ms++的配置，此参数的默认值为60000，即60秒。</p><p>主线程中发送过来的消息都会被追加到RecordAccumulator的某个双端队列(Deque)中，++RecordAccumulator内部为每个分区都维护了一个双端队列++，即Deque&lt;ProducerBatch&gt;。<br>消息写入缓存时，追加到双端队列的尾部；</p><p>Sender读取消息时，从双端队列的头部读取。注意：ProducerBatch是指一个消息批次；<br>与此同时，会将较小的ProducerBatch凑成一个较大ProducerBatch，也可以减少网络请求的次数以<br>提升整体的吞吐量。</p><p>ProducerBatch大小和++batch.size++参数也有着密切的关系。当一条消息(ProducerRecord)流入RecordAccumulator时，会先寻找与消息分区所对应的双端队列（如果没有则新建），再从这个双端<br>队列的尾部获取一个ProducerBatch(如果没有则新建)，查看ProducerBatch中是否还可以写入这个ProducerRecord，如果可以则写入，如果不可以则需要创建一个新的Producer Batch。在新建ProducerBatch时评估这条消息的大小是否超过batch.size参数大小，如果不超过，那么就以batch.size参数的大小来创建ProducerBatch。</p><p>如果生产者客户端需要向很多分区发送消息，则可以将buffer.memory参数适当调大以增加整体的吞吐量。</p><p>Sender从RecordAccumulator获取缓存的消息之后，会进一步将&lt;分区，Deque&lt;Producer Batch&gt;&gt;的形式转变成&lt;Node，List&lt;ProducerBatch&gt;&gt;的形式，其中Node表示Kafka集群broker节点。对于网络连接来说，生产者客户端是与具体broker节点建立的连接，也就是向具体的broker节点发送消息，而并不关心消息属于哪一个分区；而对于KafkaProducer的应用逻辑而言，我们只关注向哪个分区中发送哪些消息，所以在这里需要做一个应用逻辑层面到网络I&#x2F;O层面的转换。<br>在转换成&lt;Node，List&lt;ProducerBatch&gt;&gt;的形式之后，Sender会进一步封装成&lt;Node，Request&gt;的形式，这样就可以将Request请求发往各个Node了，这里的Request是Kafka各种协议请求；</p><p>请求在从sender线程发往Kafka之前还会保存到InFlightRequests中，InFlightRequests保存对象的具体形式为Map&lt;Nodeld，Deque&lt;request&gt;&gt;，++它的主要作用是缓存了已经发出去但还没有收到服务端响应的请求(Nodeld是一个String类型，表示节点的id编号)++。与此同时，InFlightRequests还提供了许多管理类的方法，并且通过配置参数还可以限制每个连接（也就是客户端与Node之间的连接)最多缓存的请求数。这个配置参数为++max.in.flight.request.per.connection++，默认值为5，即每个连接最多只能缓存5个未响应的请求，超过该数值之后就不能再向这个连接发送更多的请求了，除非有缓存的请求收到了响应（Response)。++通过比较Deque&lt;Request&gt;的size与这个参数的大小来判断对应的Node中是否己经堆积了很多未响应的消息，如果真是如此，那么说明这个Node节点负载较大或网络连接有问题++，再继续发送请求会增大请求超时的可能。</p><h2 id="10-7-重要的生产者参数"><a href="#10-7-重要的生产者参数" class="headerlink" title="10.7 重要的生产者参数"></a>10.7 重要的生产者参数</h2><h3 id="10-7-1-acks"><a href="#10-7-1-acks" class="headerlink" title="10.7.1 acks"></a>10.7.1 acks</h3><p><font size="3"><b>acks是控制生产者在发送出消息后如何得到确认；<br>生产者根据得到的确认信息，来判断消息发送是否成功；<br></b></font></p><table><thead><tr><th>acks</th><th>含义</th></tr></thead><tbody><tr><td>0</td><td>Producer往集群发送数据不需要等到集群的确认信息，不确保消息发送成功。安全性最低但是效率最高。</td></tr><tr><td>1</td><td>Producer往集群发送数据只要leader成功写入消息就可以发送下一条，只确保Leader接收成功。</td></tr><tr><td>-1或all</td><td>Producer往集群发送数据需要所有的ISR Follower都完成从Leader的同步才会发送下一条，确保Leader发送成功和所有的副本都成功接收。安全性最高，但是效率最低。</td></tr></tbody></table><p>生产者将acks设置为all，是否就一定不会丢数据呢？<br>否！如果在某个时刻ISR列表只剩leader自己了，那么就算acks&#x3D;all，收到这条数据还是只有一个节点；</p><p>可以配合另外一个参数缓解此情况：最小同步副本数 &gt;&#x3D; 2<br>Broker端参数：min.insync.replicas（默认1）</p><h3 id="10-7-2-max-request-size"><a href="#10-7-2-max-request-size" class="headerlink" title="10.7.2 max.request.size"></a>10.7.2 max.request.size</h3><p><font size="3"><b>这个参数用来限制生产者客户端能发送的消息的最大值，默认值为1048576B，即1MB<br>一般情况下，这个默认值就可以满足大多数的应用场景了。<br>这个参数还涉及一些其它参数的联动，比如broker端（topic级别参数）的++message.max.bytes++参数<br>(默认1000012)，如果配置错误可能会引起一些不必要的异常：比如将broker端的<br>message.max.bytes参数配置为10，而max.request.size参数配置为20，那么当发送一条大小为15B<br>的消息时，生产者客户端就会报出异常；<br></b></font></p><h3 id="10-7-3-retries-和-retry-backoff-ms"><a href="#10-7-3-retries-和-retry-backoff-ms" class="headerlink" title="10.7.3 retries 和 retry.backoff.ms"></a>10.7.3 retries 和 retry.backoff.ms</h3><p><u>retries参数用来配置生产者重试的次数，默认值为0，即在发生异常的时候不进行任何重试动作</u>。<br>消息在从生产者发出到成功写入服务器之前可能发生一些临时性的异常，比如网络抖动、leader副本的选举等，这种异常往往是可以自行恢复的，生产者可以通过配置retries大于0的值，以此通过内部重试来恢复而不是一味地将异常抛给生产者的应用程序。<u>如果重试达到设定的次数，那么生产者就会放弃重试并返回异</u>常。</p><p>重试还和另一个参数<u>retry.backoff.ms</u>有关，这个参数的默认值为100，它用来设定两次重试之间的时间间隔，避免无效的频繁重试。</p><p>Kafka可以保证同一个分区中的消息是有序的。如果生产者按照一定的顺序发送消息，那么这些消息也会顺序地写入分区，进而消费者也可以按照同样的顺序消费它们。对于某些应用来说，顺序性非常重要，比如MySQL binlog的传输，如果出现错误就会造成非常严重的后果；</p><p>如果将retries参数配置为非零值，并且<u>max.in.flight.requests.per.connection</u>参数配置为大于1的值，那可能会出现错序的现象：如果批次1消息写入失败，而批次2消息写入成功，那么生产者会重试发送批次1的消息，此时如果批次1的消息写入成功，那么这两个批次的消息就出现了错序。</p><p>一般而言，在需要保证消息顺序的场合建议把参数<u>max.in.flight.requests.per.connection</u>配置为1，而不是把retries配置为0，不过这样也会影响整体的吞吐。</p><h3 id="10-7-4-compression-type"><a href="#10-7-4-compression-type" class="headerlink" title="10.7.4 compression.type"></a>10.7.4 compression.type</h3><p><font size="3"><b>这个参数用来指定消息的压缩方式，默认值为“none”，即默认情况下，消息不会被压缩。<br>该参数还可以配置为”gzip”，”snappy”和”lz4”。<br>对消息进行压缩可以极大地减少网络传输、降低网络I&#x2F;O，从而提高整体的性能。<br>消息压缩是一种以时间换空间的优化方式，如果对时延有一定的要求，则不推荐对消息进行压缩；<br></b></font></p><h3 id="10-7-5-batch-size"><a href="#10-7-5-batch-size" class="headerlink" title="10.7.5 batch.size"></a>10.7.5 batch.size</h3><p><font size="3"><b>每个Batch要存放batch.size大小的数据后，才可以发送出去。比如说++batch.size默认值是16KB++，那么里面凑够16KB的数据才会发送。<br>理论上来说，提升batch.size的大小，可以允许更多的数据缓冲在recordAccumulator里面，那么一次Request发送出去的数据量就更多了，这样吞吐量可能会有所提升。<br>但是batch.size也不能过大，要是数据老是缓冲在Batch里迟迟不发送出去，那么发送消息的延迟就<br>会很高。<br>一般可以尝试把这个参数调节大些，利用生产环境发消息负载测试一下。<br></b></font></p><h3 id="10-7-6-linger-ms"><a href="#10-7-6-linger-ms" class="headerlink" title="10.7.6 linger.ms"></a>10.7.6 linger.ms</h3><p><font size="3"><b>这个参数用来指定生产者发送ProducerBatch之前等待更多消息(ProducerRecord)加入<br>ProducerBatch时间，默认值为0。<br>生产者客户端会在ProducerBatch填满或等待时间超过linger.ms值时发送出去。<br>增大这个参数的值会增加消息的延迟，但是同时能提升一定的吞吐量。<br></b></font></p><h3 id="10-7-7-enable-idempotence"><a href="#10-7-7-enable-idempotence" class="headerlink" title="10.7.7 enable.idempotence"></a>10.7.7 enable.idempotence</h3><p>是否开启幂等性功能，详见后续原理加强；<br><u>幂等性，就是一个操作重复做，也不会影响最终的结果！</u><br>int a &#x3D; 1;<br>a++; &#x2F;&#x2F;非幂等操作<br>val map &#x3D; new HashMap()<br>map.put(a,l); &#x2F;&#x2F;幂等操作</p><p>在kafka中，同一条消息，生产者如果多次重试发送，在服务器中的结果如果还是只有一条，这就是<br>具备幂等性；否则，就不具备幂等性！</p><h3 id="10-7-8-partitioner-class"><a href="#10-7-8-partitioner-class" class="headerlink" title="10.7.8 partitioner.class"></a>10.7.8 partitioner.class</h3><p>用来指定分区器，默认：org.apache.kafka.internals.DefaultPartitioner<br>默认分区器的分区规则：</p><ul><li>如果数据中有key，则按key的murmur hash值 % topie分区总数得到目标分区</li><li>如果数据只有value，则在各个分区间轮询</li></ul><p>自定义partitioner需要实现org.apache.kafka.clients.producer.Partitioner接口</p><h2 id="10-8-消费者组再均衡分区分配策略"><a href="#10-8-消费者组再均衡分区分配策略" class="headerlink" title="10.8 消费者组再均衡分区分配策略"></a>10.8 消费者组再均衡分区分配策略</h2><p>消费者组的意义何在？为了提高数据处理的并行度！</p><p>当以下事件发生时，kafka将会进行一次分区分配：</p><ul><li>同一个consumer group内新增或减少了消费者</li><li>订阅的主题新增分区</li><li>订阅的主题增加<br>将分区的消费权从一个消费者移到另一个消费者称为再均衡(rebalance)，如何rebalance也涉及到分区分配策略。<br>kafka内部存在两种的分区分配策略：range(默认)和round robin。<br>(消费者组的分区分配策略&#x2F;消费者组的负载均衡策略&#x2F;消费者组的再均衡策略)</li></ul><h3 id="10-8-1-Range-Strategy"><a href="#10-8-1-Range-Strategy" class="headerlink" title="10.8.1 Range Strategy"></a>10.8.1 Range Strategy</h3><p><font size="3"><b>先将消费者按照client.id字典排序，然后按topic逐个处理；<br>针对一个topic，将其partition总数&#x2F;消费者数 得到商n和余数m，则每个consumer至少分到n<br>个分区，且前m个consumer每人多分一个分区；<br></b></font></p><p><font size="3"><b>举例说明1：假设有TOPIC_A有5个分区，由3个consumer(C1,C2,C3)来消费；<br>5&#x2F;3得到商1，余2，则每个消费者至少分1个分区，前两个消费者各多1个分区<br>C1:2个分区，C2:2个分区，C3:1个分区<br>接下来，就按照“区间”进行分配：<br>C1：TOPIC_A-0 TOPIC_A-1<br>C2：TOPIC_A-2 TOPIC_A_3<br>C3：TOPIC_A-4<br></b></font></p><p>举例说明2：假设TOPIC_A有5个分区，TOPIC_B有3个分区，由2个consumer(C1,C2)来消费</p><ul><li>先分配TOPIC_A<br>5&#x2F;2得到商2，余1，则C1有3个分区，C2有2个分区，得到结果<br>C1：TOPIC_A-0 TOPIC_A-1 TOPIC_A-2<br>C2：TOPIC_A-3 TOPIC_A-4</li><li>再分配TOPIC_B<br>3&#x2F;2得到商1，余1，则C1有2个分区，C2有1个分区，得到结果<br>C1：TOPIC_B-0 TOPIC_B-1<br>C2：TOPIC_B-2</li><li>最终分配结果：<br>C1：TOPIC_A-0 TOPIC_A-1 TOPIC_A-2 TOPIC_B-0 TOPIC_B-1<br>C2：TOPIC_A-3 TOPIC_A-4 TOPIC_B-2</li></ul><h3 id="10-8-2-Round-Robin-Strategy"><a href="#10-8-2-Round-Robin-Strategy" class="headerlink" title="10.8.2 Round-Robin Strategy"></a>10.8.2 Round-Robin Strategy</h3><p><font size="3"><b>将所有主题分区组成TopicAndPartition列表，并对TopicAndPartition列表按照其hashCode排序,然后，以轮询的方式分配给各消费者<br></b></font></p><p>以上述“例2”来举例：</p><ul><li>先对TopicAndPartition的hashCode排序，假如排序结果如下：<br>TOPIC_A-0 TOPIC_B-0 TOPIC_A-1 TOPIC_A-2 TOPIC_B-1 TOPIC_A-3 TOPIC_A-4 TOPIC_B-2</li><li>然后按轮询方式分配<br>C1：TOPIC_A-0 TOPIC_A-1 TOPIC_B-1 TOPIC_A-4<br>C2：TOPIC_B-0 TOPIC_A-2 TOPIC_A-3 TOPIC_B-2</li></ul><p>我们可以通过++partition.assignment.strategy++参数选择range或roundrobin。<br>partition.assignment.strategy参数默认的值是range。<br>partition.assignment.strategy&#x3D;org.apache.kafka.clients.consumer.RoundRobinAssignor<br>partition.assignment.strategy&#x3D;org.apache.kafka.clients.consumer.RangeAssignor</p><p>这个参数属于“消费者”参数！</p><h3 id="10-8-3-Sticky-Strategy"><a href="#10-8-3-Sticky-Strategy" class="headerlink" title="10.8.3 Sticky Strategy"></a>10.8.3 Sticky Strategy</h3><p>对应的类叫做：org.apache.kafka.clients.consumer.StickyAssignor<br>sticky策略的特点：</p><ul><li>要去达成最大化的均衡</li><li>尽可能保留各消费者原来分配的分区</li></ul><p>再均衡的过程中，还是会让各消费者先取消自身的分区，然后再重新分配（只不过是分配过程中会尽<br>量让原来属于谁的分区依然分配给谁)</p><h3 id="10-8-3-CooperativeSticky-Strategy"><a href="#10-8-3-CooperativeSticky-Strategy" class="headerlink" title="10.8.3 CooperativeSticky Strategy"></a>10.8.3 CooperativeSticky Strategy</h3><p>对应的类叫做：org.apache.kafka.clients.consumer.ConsumerPartitionAssignor<br>sticky策略的特点：</p><ul><li>逻辑与sticky策略一致</li><li>支持cooperative再均衡机制（再均衡的过程中，不会让所有消费者取消掉所有分区然后再进行重分配）</li></ul><h2 id="10-9-消费者组再均衡流程"><a href="#10-9-消费者组再均衡流程" class="headerlink" title="10.9 消费者组再均衡流程"></a>10.9 消费者组再均衡流程</h2><p><font size="3"><b>消费组在消费数据的时候，有两个角色进行组内的各事务的协调：<br>角色1：Group Coordinator（组协调器）位于服务端（就是某个broker）<br>角色2：Group Leader（组长）位于消费端（就是消费组中的某个消费者）<br></b></font></p><h3 id="10-9-1-GroupCoordinator介绍"><a href="#10-9-1-GroupCoordinator介绍" class="headerlink" title="10.9.1 GroupCoordinator介绍"></a>10.9.1 GroupCoordinator介绍</h3><p><font size="3"><b>每个消费组在服务端对应一个GroupCoordinator进行管理，GroupCoordinator是Kafka服务端中用<br>于管理消费组的组件。<br>消费者客户端中由ConsumerCoordinator组件负责与GroupCoordinator进行交互；<br>ConsumerCoordinator和GroupCoordinator最重要的职责就是负责执行消费者rebalance操作，包括前面提及的分区分配工作也是在rebalance期间完成的。<br></b></font></p><p>会触发rebalance的事件可能是如下任意一种：</p><ul><li>有新的消费者加入消费组。</li><li>有消费者宕机下线，消费者并不一定需要真正下线，例如遇到长时间的GC、网络延迟导致消<br>费者长时间未向GroupCoordinator发送心跳等情况时，GroupCoordinator会认为消费者己下线。</li><li>有消费者主动退出消费组（发送LeaveGroupRequest请求）：比如客户端调用了unsubscrible()<br>方法取消对某些主题的订阅。</li><li>消费组所对应的GroupCoorinator节点发生了变更。</li><li>消费组内所订阅的任一主题或者主题的分区数量发生变化。</li></ul><h3 id="10-9-2-再均衡流程"><a href="#10-9-2-再均衡流程" class="headerlink" title="10.9.2 再均衡流程"></a>10.9.2 再均衡流程</h3><p><font color="green" size="4"><b>阶段1：定位Group Coordinator<br></b></font></p><p>coordinator在我们组记偏移量的__consumer_offsets分区的leader所在broker上查找Group Coordinator的方式：</p><ul><li>先根据消费组groupid的hashcode值计算它应该所在__consumer_offsets中的分区编号；<br>Utils.abc(gropId.hashCode)%groupMetadataTopicPartitionCount<br>groupMetadataTopicPartitionCount为__consumer_offsets的分区总数，这个可以通过broker端参数<br>offset.topic.num.partitions来配置，默认值是50；</li><li>找到对应的分区号后，再寻找此分区leader副本所在broker节点，则此节点即为自己的Grouping Coordinator；</li></ul><p><font color="green" size="4"><b>阶段2：加入组join the group<br></b></font></p><p>此阶段的重要操作之1：选举消费组的leader<br>private val members &#x3D; new mutable.HashMap[String, MemberMetadata]<br>var leaderid &#x3D; members.keys.head</p><p>消费组leader的选举，策略就是：随机！</p><p>此阶段的重要操作之2：选择分区分配策略<br>最终选举的分配策略基本上可以看作被各个消费者支持的最多的策略，具体的选举过程如下：<br>(1) 收集各个消费者支持的所有分配策略，组成候选集candidates<br>(2) 每个消费者从候选集candidates找出第一个自身支持的策略，为这个策略投上一票。<br>(3) 计算候选集中各个策略的选票数，选票数最多的策略即为当前消费组的分配策略。</p><p>其实，此逻辑并不需要consumer来执行，而是由Group Coordinator来执行</p><p><font color="green" size="4"><b>阶段3：组信息同步SYNC group<br></b></font></p><p><font size="3"><b>此阶段，主要是由消费组leader将分区分配方案，通过Group Coordinator来转发给组中各消费者<br></b></font></p><p><font color="green" size="4"><b>阶段4：心跳联系 HEART BEAT<br></b></font></p><p><font size="3"><b>进入这个阶段之后，消费组中的所有消费者就会处于正常工作状态。<br>各消费者在消费数据的同时，保持与Group Coordinator的心跳通信；<br></b></font></p><p>消费者的心跳间隔时间由参数++heartbeat.interval.ms++指定，默认值为3000，即这个参数必须比++session.timeout.ms++参数设定的值要小；一般情况下heartbeat.interval.ms的配置值不能超过session.timeout.ms配置值的l&#x2F;3。这个参数可以调整得更低，以控制正常重新平衡的预期时间；</p><p>如果一个消费者发生崩溃，并停止读取消息，那么GroupCoordinator会等待一小段时间确认这个消费者死亡之后才会触发再均衡。在这一小段时间内，死掉的消费者并不会读取分区里的消息。<br>这个一小段时间由session.timeout.ms参数控制，该参数的配置值必须在broker端参数</p><h3 id="10-9-3-再均衡监听器"><a href="#10-9-3-再均衡监听器" class="headerlink" title="10.9.3 再均衡监听器"></a>10.9.3 再均衡监听器</h3><p><u>一个消费组中，一旦有消费者的增减发生，会触发消费者组的rebalance再均衡；</u><br>如果想控制消费者在发生再均衡时执行一些特定的工作，可以通过订阅主题时注册“再均衡监听器”来实现；</p><p>场景举例：在发生再均衡时，处理消费位移<br>如果A消费者消费掉的一批消息还没来得及提交offset，而它所负贵的分区在rebalance中转移给了B<br>消费者，则有可能发生数据的重复消费处理。此情形下，可以通过再均衡监听器做一定程度的补救；</p><p>代码示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">consumer.subscribe(Collections.singletonList(<span class="string">&quot;tpc_5&quot;</span>), <span class="keyword">new</span> <span class="title class_">ConsumerRebalanceListener</span>()&#123;</span><br><span class="line">        <span class="comment">//被取消旧分区后被调用</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPartitionsRevoked</span><span class="params">(Collection&lt;TopicPartition&gt; collection)</span> &#123;</span><br><span class="line">            <span class="comment">//store the current offset to db</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分配到新的分区后被调用</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPartitionsAssigned</span><span class="params">(Collection&lt;TopicPartition&gt; collection)</span> &#123;</span><br><span class="line">            <span class="comment">//fetch the current offset from db</span></span><br><span class="line">I   &#125;</span><br><span class="line">&#125;)；</span><br></pre></td></tr></table></figure><h2 id="10-10-Kafka系统的CAP保证"><a href="#10-10-Kafka系统的CAP保证" class="headerlink" title="10.10 Kafka系统的CAP保证"></a>10.10 Kafka系统的CAP保证</h2><h3 id="10-10-1-分布式系统的CAP理论"><a href="#10-10-1-分布式系统的CAP理论" class="headerlink" title="10.10.1 分布式系统的CAP理论"></a>10.10.1 分布式系统的CAP理论</h3><p>CAP理论作为分布式系统的基础理论，它描述的是一个分布式系统在以下三个特性中：</p><ul><li>一致性(Consistency)</li><li>可用性(Availability)</li><li>分区容错性(Partition tolerance)</li></ul><p>最多满足其中的两个特性。也就是下图所描述的。分布式系统要么满足CA，要么CP，要么AP。无法同时满足CAP。</p><p>分区容错性：指的是分布式系统中的某个节点或者网络分区出现了故障的时候，整个系统仍然能对外提供满足一致性和可用性的服务。也就是说部分故障不影响整体使用。<br>事实上我们在设计分布式系统是都会考虑到bug，硬件，网络等各种原因造成的故障，所以即使部分节点或者网络出现故障，我们要求整个系统还是要继续使用的<br>(不继续使用，相当于只有一个分区，那么也就没有后续的一致性和可用性了)</p><p>可用性：一直可以正常的做读写操作。简单而言就是客户端一直可以正常访问并得到系统的正常响应。用户角度来看就是不会出现系统操作失败或者访问超时等问题。</p><p>一致性：在分布式系统完成某些操作后任何读操作，都应该获取到该写操作写入的那个最新的值。相当于要求分布式系统中的各节点时时刻刻保持数据的一致性。</p><p>Kafka作为一个商业级消息中间件，数据可靠性和可用性是优先考虑的重点，兼顾尽可能保证数据一致性；</p><h3 id="10-10-2-分区副本机制"><a href="#10-10-2-分区副本机制" class="headerlink" title="10.10.2 分区副本机制"></a>10.10.2 分区副本机制</h3><p><font size="3"><b>kafka从0.8.0版本开始引入了分区副本：引入了数据冗余<br>也就是说每个分区可以人为的配置几个副本（创建主题的时候指定replication-factor，也可以在broker级别进行配置default.replication.factor）；<br>在众多的分区副本里面有一个副本是Leader，其余的副本是follower，所有的读写操作都是经过Leader<br>进行的，同时follower会定期地去leader上复制数据。当Leader挂了的时候，其中一个follower会<br>重新成为新的Leader。通过分区副本，引入了数据冗余，同时也提供了kafka的数据可靠性。<br>++Kaka的分区多副本架构是Kaka可靠性保证的核心，把消息写入多个副本可以使Kaka在发生<br>崩溃时仍能保证消息的持久性。++<br></b></font></p><h3 id="10-10-3-ISR同步副本列表"><a href="#10-10-3-ISR同步副本列表" class="headerlink" title="10.10.3 ISR同步副本列表"></a>10.10.3 ISR同步副本列表</h3><p><font size="3"><b>ISR概念：（同步副本）。每个分区的leader会维护一个ISR列表，ISR列表里面就是follower副本的broker编号，只有跟得上Leader的follower副本才能加入到ISR里面，这个是通过<u>replica.lag.time.max.ms</u>&#x3D;l0000(默认值)参数配置的，<u>只有ISR里的成员才有被选为leader的可能。</u><br></b></font></p><h3 id="10-10-4-分区副本的数据一致性解决方案"><a href="#10-10-4-分区副本的数据一致性解决方案" class="headerlink" title="10.10.4 分区副本的数据一致性解决方案"></a>10.10.4 分区副本的数据一致性解决方案</h3><p><font size="3"><b>kafka让分区多副本同步的基本手段是：follower副本定期向leader请求数据同步！<br>既然是定期同步，则leader和follower之间必然存在各种数据不一致的情景！<br></b></font></p><p>动态过程中的副本数据不一致，是很难解决的；<br>kafka先尝试着解决上述“消费者所见不一致”及“分区数据最终不一致”的问题；</p><p>解决方案的核心思想</p><ul><li>在动态不一致的过程中，维护一条步进式的“临时一致线”（既所谓的High Watermark);</li><li>高水位线HW&#x3D;ISR副本中最小LEO+1；</li><li>底层逻辑就是：offset &lt; HW的message，是各副本间一致的且安全的！</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114824.png" alt="Kafka图11"></p><p><font size="3"><b>如上图所示：offset &lt; HW:3 的message，是所有副本都已经备份好的数据<br></b></font></p><p><font color="DeepPink" size="3"><b>解决“消费者所见不一致”（消费者只允许看到HW以下的message）<br></b></font></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114562.png" alt="Kafka图12"></p><p><font color="DeepPink" size="3"><b>解决“分区副本数据最终不一致”（follower数据按HW截断）<br></b></font></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114124.png" alt="Kafka图13"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114196.png" alt="Kafka图14"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114067.png" alt="Kafka图15"></p><h3 id="10-10-5-HW方案的天生缺陷"><a href="#10-10-5-HW方案的天生缺陷" class="headerlink" title="10.10.5 HW方案的天生缺陷"></a>10.10.5 HW方案的天生缺陷</h3><p>如前所述，看似HW解决了“分区数据最终不一致”的问题，以及“消费者所见不一致”的问题，但其实，这里面存在一个巨大的隐患，导致：</p><ul><li>“分区数据最终不一致”的问题依然存在</li><li>producer设置acks&#x3D;al后，依然有可能丢失数据的问题</li></ul><p>产生如上结果的根源是：++HW高水位线的更新，与数据同步的进度，存在迟滞！++</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114646.png" alt="Kafka图16"></p><p>Step 1： leader和follower副本处于初始化值，follower副本发送fetch请求，由于leader副本没有数据，因此不会进行同步操作；</p><p>Step2： 生产者发送了消息m1到分区leader副本，写入该条消息后leader更新LEO&#x3D;1；</p><p>Step3： follower发送fetch请求，携带当前最新的offset&#x3D;0，leader处理fetch请求时，更新remote LEO&#x3D;0，对比LEO值最小为0，所以HW&#x3D;0，leader副本响应消息数据及leader HW&#x3D;0给follower，follower写入消息后，更新LEO值，同时对比leader HW值，取最小的作为新的HW值，此时follower HW&#x3D;0，这也意味着，follower HW是不会超过leader HW值的。</p><p>Step4： follower发送第二轮fetch请求，携带当前最新的offset&#x3D;l，leader处理fetch请求时，更新remote LEO&#x3D;l，对比LEO值最小为l，所以HW&#x3D;l，此时leader没有新的消息数据，所以直接返回leader HW&#x3D;1给follower，follower对比当前最新的LEO值与leader HW值，取最小的作为新的HW值，此时follower HW&#x3D;1。</p><p><font size="3"><b>从以上步骤可看出，leader中保存的remote LEO值的更新（也即HW的更新)总是需要额外一轮<br>fetch RPC请求才能完成，这意味着在leader切换过程中，会存在数据丢失以及数据不一致的问题！<br></b></font></p><h3 id="10-10-6-HW会产生数据丢失和副本最终不一致问题"><a href="#10-10-6-HW会产生数据丢失和副本最终不一致问题" class="headerlink" title="10.10.6 HW会产生数据丢失和副本最终不一致问题"></a>10.10.6 HW会产生数据丢失和副本最终不一致问题</h3><p><font color="Crimson" size="3"><b>数据丢失的问题（即使produce设置acks&#x3D;all，依然会发生）<br></b></font></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114586.png" alt="Kafka图17"></p><p><font color="red" size="3"><b>注意：leader中的HW值是在follower下一轮fetch RPC请求中完成更新的<br></b></font></p><p>如上图所示：</p><ul><li>状态起始：B为leader，A为follower；最新消息m2已同步，但B的HW比A的HW大1</li><li>A在此时崩溃（即follower没能通过下一轮请求来更新HW值）</li><li>A重启时，会自动将LEO值调整到之前的HW值，即会进行日志截断</li><li>B重启后，会从向A发送fetch请求，收到fetch响应后，拿到HW值，并更新本地HW值，这时B会做日志截断，因此，offsets&#x3D;1的消息被永久地删除了。</li></ul><p><font color="Crimson" size="3"><b>副本间数据最终不一致的问题（即使produce设置acks&#x3D;all，依然会发生）<br></b></font></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114328.png" alt="Kafka图18"></p><p>如上图所示：</p><ul><li>状态起始：A为leader，B为follower；最新消息m2已同步，但B的HW比A的HW大1</li><li>A在此时崩溃（即follower没能通过下一轮请求来更新HW值）</li><li>B先重启，会自动将LEO值调整到之前的W值，即会进行日志截断，并在此刻接收了新的消息m3，HW随之上升为2</li><li>然后，A重启上线，会从向B发送fetch请求，收到fetch响应后，拿到HW值，并更新本<br>地HW值，发现不需要截断，从而己经产生了“副本间数据最终不一致”！</li></ul><p><font size="3"><b>只要新一届leader在老leader重启上线前，接收了新的数据，就可能发生上图中的场景，根源也在于HW的更新落后于数据同步进度<br></b></font></p><h3 id="10-10-7-Leader-Epoch机制的引入"><a href="#10-10-7-Leader-Epoch机制的引入" class="headerlink" title="10.10.7 Leader-Epoch机制的引入"></a>10.10.7 Leader-Epoch机制的引入</h3><p><font size="3"><b>为了解决HW更新时机是异步延迟的，而HW又是决定日志是否备份成功的标志，从而造成数据丢失和数据不一致的现象，Kafka引入了leader epoch机制；<br>在每个副本日志目录下都创建一个leader-epoch-checkpoint文件，用于保存leader的epoch信息；<br></b></font></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132114771.png" alt="Kafka图19"></p><p><font size="3"><b>它的格式为(epoch offset)，epoch指的是leader版本，它是一个单调递增的一个正整数值，每次leader变更，epoch版本都会+l，offset是每一代leader写入的第一条消息的位移值，比如：<br>(0,0)<br>(1,300)<br>以上第2个版本是从位移300开始写入消息，意味着第一个版本写入了0-299的消息。<br></b></font></p><p>leader epoch具体的工作机制</p><ul><li><p>当副本成为leader时：<br>这时，如果此时生产者有新消息发送过来，会首先更新leader epoch以及LEO，并添加到<br>leader–epoch-checkpoint文件中；</p></li><li><p>当副本变成follower时：<br>发送LeaderEpochRequest请求给leader副本，该请求包括了follower中最新的epoch版本；<br>leader返回给follower的响应中包含了一个LastOffset，如果follower last epoch&#x3D;leader last epoch(纪元相同)，则LastOffset&#x3D;leader LEO，否则取follower last epoch中最小的leader epoch的start offset值；</p></li></ul><p><font size="3"><b>举个例子：假设follower last epoch&#x3D;1，此时leader有(1,20)(2,80)(3,120)，则LastOffset&#x3D;80；follower拿到LastOffset之后，会对比当前LEO值是否大于LastOffset，如果当前LEO大于LastOffset，则从LastOffset截断日志；<br>follower开始发送fetch请求给leader保持消息同步。<br></b></font></p><p><font color="OrangeRed" size="3"><b>解决数据丢失：<br></b></font></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132115476.png" alt="Kafka图20"></p><p><font size="3"><b>如上图所示：<br>A重启之后，发送LeaderEpochRequest请求给B，由于B还没追加消息，此时epoch&#x3D;request epoch<br>&#x3D;0，因此返LastOffset&#x3D;leader LEO&#x3D;2给A<br>A拿到LastOffset之后，发现等于当前LEO值，故不用进行日志截断。就在这时B宕机了，A成为leader，在B启动回来后，会重复A的动作，同样不需要进行日志截断，数据没有丢失。<br></b></font></p><p><font color="OrangeRed" size="3"><b>解决数据最终不一致问题：<br></b></font></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/YiYuTET/ImageStorage/202304132115693.png" alt="Kafka图21"></p><p>如上图所示：</p><ul><li>A和B同时宕机后，B先重启回来成为分区leader，这时候生产者发送了一条消息过来，leader<br>epoch更新到1</li><li>此时A启动回来后，发送LeaderEpochRequest(follower epoch&#x3D;0)给B，B判断follower epoch<br>不等于最新的epoch，于是找到大于follower epoch最小的epoch&#x3D;l，即LastOffset&#x3D;epoch start offset&#x3D;1</li><li>A拿到LastOffset后，判断小于当前LEO值，于是从LastOffset位置进行日志截断，接着开<br>始发送fetch请求给B开始同步消息，避免了消息不一致&#x2F;离散的问题。</li></ul><h3 id="10-10-8-LEO-HW-LSO等相关术语速查"><a href="#10-10-8-LEO-HW-LSO等相关术语速查" class="headerlink" title="10.10.8 LEO&#x2F;HW&#x2F;LSO等相关术语速查"></a>10.10.8 LEO&#x2F;HW&#x2F;LSO等相关术语速查</h3><p><font size="3"><b>LEO：(last end offset) 就是该副本中消息的最大偏移量的值+1；<br>HW：(high watermark) 各副本中LEO的最小值。这个值规定了消费者仅能消费HW之前的数据；<br>LW：(low watermark) 一个副本的log中，最小的消息偏移量；     <br>LS0：(last stable offset) 最后一个稳定的offset；<br>对未完成的事务而言，LSO的值等于事务<br>中第一条消息的位置(firstUnstableOffset)，对已完成的事务而言，它的值同HW相同；<br></b></font></p></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2024/02/29/8f4db1ac8f79a3be.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2024/02/29/8f4db1ac8f79a3be.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">YiYuTET</div><div class="post-copyright__author_desc">分享技术与快乐的博主</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/post/216d6a00.html">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("http://example.com/post/216d6a00.html")'>10. Kafka 关键原理加强</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/null" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/null" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div><div class="reward-link mode"><a class="reward-link-button" href="/wechat/"><i class="anzhiyufont anzhiyu-icon-plant-fill"></i>运营模式与责任</a></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/post/216d6a00.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=10. Kafka 关键原理加强&amp;url=http://example.com/post/216d6a00.html&amp;pic=/image/kafka.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">依羽淡蓝</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Kafka/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Kafka<span class="tagsPageCount">6</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/image/java.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/b2c5a78a.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/kafka.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">8-9 Kafka 系统架构</div></div></a></div><div class="next-post pull-right"><a href="/post/9c657266.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/zookeeper.jpeg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CentOS7---ZooKeeper伪分布式安装部署</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/post/58eeb88f.html" title="1-3 Kafka 简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-12</div><div class="title">1-3 Kafka 简介</div></div></a></div><div><a href="/post/79d4ebb8.html" title="4. Kafka 命令行工具"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-12</div><div class="title">4. Kafka 命令行工具</div></div></a></div><div><a href="/post/fa7bdefa.html" title="5-7 Kafka API开发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-12</div><div class="title">5-7 Kafka API开发</div></div></a></div><div><a href="/post/b2c5a78a.html" title="8-9 Kafka 系统架构"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-12</div><div class="title">8-9 Kafka 系统架构</div></div></a></div><div><a href="/post/8716a180.html" title="云服务器伪分布式部署Kafka"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-12</div><div class="title">云服务器伪分布式部署Kafka</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Waline</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2024/02/29/8f4db1ac8f79a3be.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"></div></div><div class="author-info__description"><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">这有关于<b style="color:#fff">Java、大数据、算法</b>相关的问题和看法，还有<b style="color:#fff">文章总结</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">YiYuTET</h1><div class="author-info__desc">分享技术与快乐的博主</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/YiYuTET" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/201372650" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background:url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center/100% no-repeat"></div><div class="back face" style="background:url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center/100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#10-Kafka-%E5%85%B3%E9%94%AE%E5%8E%9F%E7%90%86%E5%8A%A0%E5%BC%BA"><span class="toc-number">1.</span> <span class="toc-text">10. Kafka 关键原理加强</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-%E6%97%A5%E5%BF%97%E5%88%86%E6%AE%B5%E5%88%87%E5%88%86%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">10.1 日志分段切分条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-controller%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">1.2.</span> <span class="toc-text">10.2 controller控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-%E5%88%86%E5%8C%BA%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%88%86%E5%B8%83"><span class="toc-number">1.3.</span> <span class="toc-text">10.3 分区的负载分布</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E5%88%86%E5%8C%BALeader%E7%9A%84%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.</span> <span class="toc-text">10.4 分区Leader的选举机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-5-%E5%88%86%E5%8C%BA%E6%95%B0%E4%B8%8E%E5%90%9E%E5%90%90%E9%87%8F"><span class="toc-number">1.5.</span> <span class="toc-text">10.5 分区数与吞吐量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-6-%E7%94%9F%E4%BA%A7%E8%80%85%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="toc-number">1.6.</span> <span class="toc-text">10.6 生产者原理解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-7-%E9%87%8D%E8%A6%81%E7%9A%84%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%82%E6%95%B0"><span class="toc-number">1.7.</span> <span class="toc-text">10.7 重要的生产者参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-1-acks"><span class="toc-number">1.7.1.</span> <span class="toc-text">10.7.1 acks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-2-max-request-size"><span class="toc-number">1.7.2.</span> <span class="toc-text">10.7.2 max.request.size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-3-retries-%E5%92%8C-retry-backoff-ms"><span class="toc-number">1.7.3.</span> <span class="toc-text">10.7.3 retries 和 retry.backoff.ms</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-4-compression-type"><span class="toc-number">1.7.4.</span> <span class="toc-text">10.7.4 compression.type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-5-batch-size"><span class="toc-number">1.7.5.</span> <span class="toc-text">10.7.5 batch.size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-6-linger-ms"><span class="toc-number">1.7.6.</span> <span class="toc-text">10.7.6 linger.ms</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-7-enable-idempotence"><span class="toc-number">1.7.7.</span> <span class="toc-text">10.7.7 enable.idempotence</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-8-partitioner-class"><span class="toc-number">1.7.8.</span> <span class="toc-text">10.7.8 partitioner.class</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-8-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E5%86%8D%E5%9D%87%E8%A1%A1%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-number">1.8.</span> <span class="toc-text">10.8 消费者组再均衡分区分配策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-8-1-Range-Strategy"><span class="toc-number">1.8.1.</span> <span class="toc-text">10.8.1 Range Strategy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-8-2-Round-Robin-Strategy"><span class="toc-number">1.8.2.</span> <span class="toc-text">10.8.2 Round-Robin Strategy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-8-3-Sticky-Strategy"><span class="toc-number">1.8.3.</span> <span class="toc-text">10.8.3 Sticky Strategy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-8-3-CooperativeSticky-Strategy"><span class="toc-number">1.8.4.</span> <span class="toc-text">10.8.3 CooperativeSticky Strategy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-9-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E5%86%8D%E5%9D%87%E8%A1%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">1.9.</span> <span class="toc-text">10.9 消费者组再均衡流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-9-1-GroupCoordinator%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.9.1.</span> <span class="toc-text">10.9.1 GroupCoordinator介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-9-2-%E5%86%8D%E5%9D%87%E8%A1%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">1.9.2.</span> <span class="toc-text">10.9.2 再均衡流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-9-3-%E5%86%8D%E5%9D%87%E8%A1%A1%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">1.9.3.</span> <span class="toc-text">10.9.3 再均衡监听器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-10-Kafka%E7%B3%BB%E7%BB%9F%E7%9A%84CAP%E4%BF%9D%E8%AF%81"><span class="toc-number">1.10.</span> <span class="toc-text">10.10 Kafka系统的CAP保证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-10-1-%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84CAP%E7%90%86%E8%AE%BA"><span class="toc-number">1.10.1.</span> <span class="toc-text">10.10.1 分布式系统的CAP理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-10-2-%E5%88%86%E5%8C%BA%E5%89%AF%E6%9C%AC%E6%9C%BA%E5%88%B6"><span class="toc-number">1.10.2.</span> <span class="toc-text">10.10.2 分区副本机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-10-3-ISR%E5%90%8C%E6%AD%A5%E5%89%AF%E6%9C%AC%E5%88%97%E8%A1%A8"><span class="toc-number">1.10.3.</span> <span class="toc-text">10.10.3 ISR同步副本列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-10-4-%E5%88%86%E5%8C%BA%E5%89%AF%E6%9C%AC%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.10.4.</span> <span class="toc-text">10.10.4 分区副本的数据一致性解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-10-5-HW%E6%96%B9%E6%A1%88%E7%9A%84%E5%A4%A9%E7%94%9F%E7%BC%BA%E9%99%B7"><span class="toc-number">1.10.5.</span> <span class="toc-text">10.10.5 HW方案的天生缺陷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-10-6-HW%E4%BC%9A%E4%BA%A7%E7%94%9F%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E5%92%8C%E5%89%AF%E6%9C%AC%E6%9C%80%E7%BB%88%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98"><span class="toc-number">1.10.6.</span> <span class="toc-text">10.10.6 HW会产生数据丢失和副本最终不一致问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-10-7-Leader-Epoch%E6%9C%BA%E5%88%B6%E7%9A%84%E5%BC%95%E5%85%A5"><span class="toc-number">1.10.7.</span> <span class="toc-text">10.10.7 Leader-Epoch机制的引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-10-8-LEO-HW-LSO%E7%AD%89%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD%E9%80%9F%E6%9F%A5"><span class="toc-number">1.10.8.</span> <span class="toc-text">10.10.8 LEO&#x2F;HW&#x2F;LSO等相关术语速查</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/256339cb.html" title="Java设计模式 1.Singleton-单例模式"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/java.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Java设计模式 1.Singleton-单例模式"></a><div class="content"><a class="title" href="/post/256339cb.html" title="Java设计模式 1.Singleton-单例模式">Java设计模式 1.Singleton-单例模式</a><time datetime="2024-03-13T06:30:43.000Z" title="发表于 2024-03-13 14:30:43">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/13c31df7.html" title="最长回文子串"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/leetcode.jpeg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="最长回文子串"></a><div class="content"><a class="title" href="/post/13c31df7.html" title="最长回文子串">最长回文子串</a><time datetime="2024-03-13T06:30:00.000Z" title="发表于 2024-03-13 14:30:00">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/67d9c1da.html" title="分治法 快速排序"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/leetcode.jpeg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="分治法 快速排序"></a><div class="content"><a class="title" href="/post/67d9c1da.html" title="分治法 快速排序">分治法 快速排序</a><time datetime="2024-03-13T06:28:47.000Z" title="发表于 2024-03-13 14:28:47">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/eb1d1d4b.html" title="3-6. FlinkSql 表相关"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/flink.jpeg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="3-6. FlinkSql 表相关"></a><div class="content"><a class="title" href="/post/eb1d1d4b.html" title="3-6. FlinkSql 表相关">3-6. FlinkSql 表相关</a><time datetime="2024-03-13T02:45:03.000Z" title="发表于 2024-03-13 10:45:03">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/71bf0702.html" title="2. FlinkSql 编程概览"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/image/flink.jpeg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="2. FlinkSql 编程概览"></a><div class="content"><a class="title" href="/post/71bf0702.html" title="2. FlinkSql 编程概览">2. FlinkSql 编程概览</a><time datetime="2024-03-13T02:44:26.000Z" title="发表于 2024-03-13 10:44:26">2024-03-13</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="/2576556095@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/6378063631" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://www.facebook.com/profile.php?id=100092208016287&amp;sk=about" title="facebook"><i class="anzhiyufont anzhiyu-icon-facebook1"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2024/02/29/8f4db1ac8f79a3be.jpg" size="50px"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/372204786" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://v.douyin.com/DwCpMEy/" title="抖音"><i class="anzhiyufont anzhiyu-icon-tiktok"></i></a></div><div id="workboard"><div id="runtimeTextTip"></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v7.1.1" title="博客框架为Hexo_v7.1.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v7.1.1"></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"></a><a class="github-badge" target="_blank" href="https://www.upyun.com/" style="margin-inline:5px" data-title="本站使用又拍云为静态资源提供CDN加速" title="本站使用又拍云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://unpkg.com/yiyutet-static@1.0.2/image/CDN.svg" alt="本站使用又拍云为静态资源提供CDN加速"></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2024 By <a class="footer-bar-link" href="/" title="YiYuTET" target="_blank">YiYuTET</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType(){fetch("https://v1.hitokoto.cn").then(t=>t.json()).then(t=>{{const e="出自 "+t.from,p=["生活明朗，万物可爱，人间值得，未来可期。","手握日月摘 ♥ 辰。","天若有情天亦老，人间正道是沧桑。","三十功名尘与土，八千里路云和月。","此去黄泉招旧部，旌旗十万斩阎罗。"];p.unshift(t.hitokoto,e),window.typed=new Typed("#footer-type-tips",{strings:p,startDelay:300,typeSpeed:150,loop:!0,backSpeed:50})}})}"function"==typeof Typed?subtitleType():getScript("https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js").then(subtitleType)</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="赣ICP备2022002607号">赣ICP备2022002607号</a><a class="footer-bar-link cc" href="/copyright" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">12</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://yiyuyyds.cn/" title="依羽淡蓝的博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="依羽淡蓝的博客"><span class="back-menu-item-text">依羽淡蓝的博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://upyun.com/" title="又拍云"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="又拍云"><span class="back-menu-item-text">又拍云</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://music.163.com/" title="网易云音乐"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="网易云音乐"><span class="back-menu-item-text">网易云音乐</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"><span class="back-menu-item-text">安知鱼图床</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://7bu.top/" title="去不图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="去不图床"><span class="back-menu-item-text">去不图床</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.imgurl.org/" title="ImgURL"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="ImgURL"><span class="back-menu-item-text">ImgURL</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=5085901384&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i><span> 我的装备</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size:.88rem">AI<sup>1</sup></a><a href="/tags/Azkaban/" style="font-size:.88rem">Azkaban<sup>1</sup></a><a href="/tags/Flink/" style="font-size:.88rem">Flink<sup>22</sup></a><a href="/tags/HBase/" style="font-size:.88rem">HBase<sup>2</sup></a><a href="/tags/Hadoop/" style="font-size:.88rem">Hadoop<sup>1</sup></a><a href="/tags/Hive/" style="font-size:.88rem">Hive<sup>1</sup></a><a href="/tags/Hue/" style="font-size:.88rem">Hue<sup>4</sup></a><a href="/tags/Java/" style="font-size:.88rem">Java<sup>1</sup></a><a href="/tags/Kafka/" style="font-size:.88rem">Kafka<sup>6</sup></a><a href="/tags/Spark/" style="font-size:.88rem">Spark<sup>1</sup></a><a href="/tags/ZooKeeper/" style="font-size:.88rem">ZooKeeper<sup>1</sup></a><a href="/tags/%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" style="font-size:.88rem">安装教程<sup>12</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:.88rem">算法<sup>2</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size:.88rem">设计模式<sup>1</sup></a></div></div><hr></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="5085901384" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/9164517845&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask(()=>{const o=function(){HoldLog.apply(console,arguments)},n=new Date("02/22/2024 00:00:00");now1.setTime(now1.getTime()+250);const c=(now1-n)/1e3/60/60/24,e=["欢迎使用安知鱼!","生活明朗, 万物可爱","\n        \n       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗\n      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║\n      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║\n      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║\n      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝\n      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝\n        \n        ","已上线",Math.floor(c),"天","©2024 By 安知鱼 V1.6.12"],t=["NCC2-036","调用前置摄像头拍照成功，识别为【小笨蛋】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`\n%c${e[0]} %c ${e[1]} %c ${e[2]} %c${e[3]}%c ${e[4]}%c ${e[5]}\n\n%c ${e[6]}\n`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${t[0]} %c ${t[1]} %c \n${t[2]} %c\n${t[3]}\n`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，小笨蛋.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 YiYuTET 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))})</script><script async src="/anzhiyu/random.js"></script><script async>!function(){var e,t,n,r,a,i=new Date("02/22/2024 00:00:00"),o=new Date;setInterval(()=>{!function(){o=new Date,a=o.getHours();var l=(o-i)/1e3/60/60/24;e=Math.floor(l);var u=(o-i)/1e3/60/60-24*e;t=Math.floor(u),1==String(t).length&&(t="0"+t);var c=(o-i)/1e3/60-1440*e-60*t;n=Math.floor(c),1==String(n).length&&(n="0"+n);var s=(o-i)/1e3-86400*e-3600*t-60*n;r=Math.round(s),1==String(r).length&&(r="0"+r)}(),function(){if(!document.getElementById("footer"))return;let i="";if(a<18&&a>=9)i=`本站居然运行了 ${e} 天<span id='runtime'> ${t} 小时 ${n} 分 ${r} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;else{let a=document.querySelector("#workboard .workSituationImg");null!=a&&(a.src="",a.title="",a.alt=""),i=`本站居然运行了 ${e} 天<span id='runtime'> ${t} 小时 ${n} 分 ${r} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`}document.getElementById("runtimeTextTip")&&(document.getElementById("runtimeTextTip").innerHTML=i)}()},1e3)}()</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(()=>{const t=()=>{"object"==typeof twikoo?setTimeout(o,0):getScript("https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js").then(o)},o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://yiyu9901-twikoo.hf.space",region:"ap-nanchang",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const t=document.getElementById("twikoo-count");t&&twikoo.getCommentsCount({envId:"https://yiyu9901-twikoo.hf.space",region:"ap-nanchang",urls:[window.location.pathname],includeReply:!1}).then(o=>{t.textContent=o[0].count}).catch(t=>{console.error(t)})})()};t()})()</script><script>(()=>{const t=()=>{Waline.init(Object.assign({el:"#waline-wrap",serverURL:"https://waline-2ig2mjss4-yiyutets-projects.vercel.app/",pageview:!1,dark:'html[data-theme="dark"]',path:window.location.pathname,comment:!0},null))},e=async()=>{"object"==typeof Waline||(await getCSS("https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.css"),await getScript("https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.js")),t()};setTimeout(e,0)})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener("load",()=>{const e=e=>{let t="";if(e.length)for(let n=0;n<e.length;n++){t+="<div class='aside-list-item'>";{const a="data-lazy-src";t+=`<a href='${e[n].url}' class='thumbnail'><img ${a}='${e[n].avatar}' alt='${e[n].nick}'><div class='name'><span>${e[n].nick} </span></div></a>`}t+=`<div class='content'>\n        <a class='comment' href='${e[n].url}' title='${e[n].content}'>${e[n].content}</a>\n        <time datetime="${e[n].date}">${anzhiyu.diffDate(e[n].date,!0)}</time></div>\n        </div>`}else t+="没有评论";let n=document.querySelector("#card-newest-comments .aside-list");n&&(n.innerHTML=t),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(n)},t=()=>{if(document.querySelector("#card-newest-comments .aside-list")){const t=saveToLocal.get("twikoo-newest-comments");t?e(JSON.parse(t)):(()=>{const t=()=>{twikoo.getRecentComments({envId:"https://yiyu9901-twikoo.hf.space",region:"ap-nanchang",pageSize:6,includeReply:!0}).then((function(t){const n=t.map(e=>{return{content:(t=e.comment,""===t||(t=(t=(t=(t=t.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length>150&&(t=t.substring(0,150)+"..."),t),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()};var t});saveToLocal.set("twikoo-newest-comments",JSON.stringify(n),10/1440),e(n)})).catch((function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"}))};"object"==typeof twikoo?t():getScript("https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js").then(t)})()}};t(),document.addEventListener("pjax:complete",t)})</script><script async data-pjax src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail="visitor@yiyutet.com"</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script defer id="fluttering_ribbon" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script>(()=>{{const a=()=>{Chatra("minimizeWidget"),Chatra("hide")},t=()=>{Chatra("openChat",!0),Chatra("show")};window.ChatraSetup={startHidden:!0},window.chatBtnFn=()=>{document.getElementById("chatra").classList.contains("chatra--expanded")?a():t()}}!function(a,t,n){t.ChatraID="Q6Jamb3w4rWdjgCzA";var e=a.createElement("script");t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},e.async=!0,e.src="https://call.chatra.io/chatra.js",a.head&&a.head.appendChild(e)}(document,window,"Chatra")})()</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script data-pjax>function butterfly_clock_anzhiyu_injector_config(){var e=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载butterfly_clock_anzhiyu"),e&&e.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",qweather_key="841fa5c76e5a4ca59a8f5b618e989540# 和风天气key",gaud_map_key="374456b7f8ca92155e3fb0c1f99c2b78# 高得地图web服务key",baidu_ak_key="undefined",flag=0,clock_rectangle="112.982279,28.19409",clock_default_rectangle_enable="false",i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_clock_anzhiyu_injector_config()</script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script></body></html>